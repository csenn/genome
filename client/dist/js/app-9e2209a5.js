angular.module("genomeApp",["ngRoute","dePartials"]).config(["$routeProvider","$locationProvider","$httpProvider",function(e){e.when("/search",{templateUrl:"/search/search.html",controller:"SearchCtrl",reloadOnSearch:!1}).otherwise({redirectTo:"/search"})}]),angular.module("genomeApp").factory("NcbiApi",["$http","$q","$rootScope",function(e,t,n){function r(e,t){return e=angular.isArray(e)?e:[e],e.concat(t)}function a(){u+=1,1===u&&n.$emit("request-sent")}function o(){u-=1,0===u&&n.$emit("requests-received")}function i(n){var r=t.defer();return a(),e(n).success(function(e){o(),r.resolve(e)}).error(function(e){o(),r.reject(e)}),r.promise}var c="http://eutils.ncbi.nlm.nih.gov/entrez/eutils",s={INFO:c+"/einfo.fcgi",SEARCH:c+"/esearch.fcgi",SUMMARY:c+"/esummary.fcgi",FETCH:c+"/efetch.fcgi"},u=0;return{info:function(e){var t={method:"GET",url:s.INFO,params:{db:e.db,version:"2.0",retmode:e.retmode||"json"}};return i(t)},search:function(e){var t={method:"GET",url:s.SEARCH+"?term="+e.search,params:{db:e.db,retmax:e.retmax||20,retstart:e.retstart||void 0,retmode:e.retmode||"json",sort:e.sort||void 0}};return i(t)},summary:function(t){var n={method:"GET",url:s.SUMMARY,params:{db:t.db,retmode:t.retmode||"json",id:t.id}};return t.transformResponse&&(n.transformResponse=r(e.defaults.transformResponse,t.transformResponse)),i(n)},fetch:function(t){var n={method:"GET",url:s.FETCH,params:{db:t.db,id:t.id,retmax:t.retmax||20,retmode:t.retmode||void 0,rettype:t.rettype||void 0}};return t.transformResponse&&(n.transformResponse=r(e.defaults.transformResponse,t.transformResponse)),i(n)}}}]),angular.module("genomeApp").directive("geCollapse",function(){return{templateUrl:"/common/partials/directive-collapse.html",replace:!0,restrict:"E",transclude:!0,scope:{label:"=",showIcon:"="},link:function(e,t,n){e.isOpen=n.open||!1,e.doShowIcon=function(){return n.showIcon?e.showIcon?!0:!1:!0}}}}),angular.module("genomeApp").directive("dropDown",function(){return{templateUrl:"/common/partials/directive-drop-down.html",replace:!0,restrict:"E",scope:{items:"=",selectedItem:"="},link:function(e,t){function n(){for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZ",t=[],n=0;8>n;n++){var r=Math.floor(Math.random()*e.length);t.push(e[r])}return t.join("")}var r=t.children("button"),a=t.children("ul"),o=n();r.attr("data-dropdown",o),a.attr("id",o),$(document).foundation(t),e.selectItem=function(t,n){0!==n&&(e.selectedItem=t,Foundation.libs.dropdown.close(a))}}}}),angular.module("genomeApp").directive("geSpinner",["$rootScope",function(e){return{template:'<img src="common/images/spinner.gif">',replace:!0,restrict:"E",link:function(t,n){n.hide(),e.$on("request-sent",function(){n.show()}),e.$on("requests-received",function(){n.hide()})}}}]),angular.module("genomeApp").controller("SearchCtrl",["$scope","$http","NcbiApi","RequestHandler","SearchQuery","$location",function(e,t,n,r,a,o){function i(){var e=o.search();e.db&&c(e.db),e.term&&a.setCurrentText(e.term)}function c(t){angular.forEach(e.dbs,function(n){n.name===t&&(e.selectedDb=n)})}function s(e){return-1!==e.indexOf("[UID]")}function u(){var t=!1,r=e.selectedDb.name,i=a.getCurrentTextMachine();if(r&&i){o.search("term",i),t=s(i);var c={db:r,search:i,retmax:e.search.query.limit,retstart:e.search.query.limit*e.search.query.page,sort:"relevance"};e.showZeroResults=!1,n.search(c).then(function(n){var r=n.esearchresult.idlist,a=Number(n.esearchresult.count);e.search.resultCount=a,0===a&&(e.showZeroResults=!0),r&&r.length&&l(r,t)},function(e){console.log(e)})}}function l(t,n){var a=e.selectedDb.name;e.search.results.length=0,r.summary(a,t).then(function(t){angular.forEach(t.result,function(t,n){"uids"!==n&&e.search.results.push(t)}),n&&e.selectSearchResult(e.search.results[0])},function(e){console.log(e)})}function d(t){var n=e.selectedDb.name,a=r.fetch(n,t);a&&a.then(function(t){e.selectedData.details=t},function(e){console.log(e)})}e.dbs=[{display:"Choose One",name:null,desc:"Brief Description"},{display:"Gene",name:"gene",desc:"Gene provides detailed information about genes"},{display:"Med Gen",name:"medgen",desc:"Med Gen provides information about genetic diseases and findings"},{display:"Protein",name:"protein",desc:"Protein provides sequence and genome info"}],e.selectedDb=e.dbs[0],e.selectedData={summary:null,details:null},e.showZeroResults=!1,e.search={text:"",results:[],resultCount:0,query:{page:0,limit:20}},i(),e.getSynonymnString=function(e){return angular.isArray(e)?e.join("; "):""},e.getPageSpread=function(){var t,n,r=e.search.query.page,a=e.search.query.limit,o=e.search.resultCount;return o?(t=r*a+1,n=r*a+a,n>o&&(n=o),t+"-"+n):void 0},e.selectSearchResult=function(t){e.selectedData.summary=t,d(t.uid)},e.$watch("selectedDb",function(t){e.showZeroResults=!1,e.search.resultCount=0,t.name&&o.search("db",t.name)}),e.$watch("search.text",function(){e.showZeroResults=!1}),e.toggleHelp=function(){e.showHelp=!e.showHelp,e.showAdvanced&&(e.showAdvanced=!1)},e.toggleAdvanced=function(){e.showAdvanced=!e.showAdvanced,e.showAdvanced&&(e.showHelp=!1)},e.$watch(function(){return a.getCurrentTextReadable()},function(t){e.showDbTutorial=!1,e.search.text=t,u()}),e.searchForText=function(t){e.search.query.page=0,a.setCurrentText(t)},e.nextPage=function(){var t=e.search,n=t.resultCount,r=t.query.limit,a=t.query.page+1;a*r>=n||(t.results.length=0,t.query.page+=1,u())},e.previousPage=function(){var t=e.search;t.query.page>0&&(t.results.length=0,t.query.page-=1,u())}}]),angular.module("genomeApp").factory("SearchQuery",function(){function e(e){this.operator=e.operator,this.fullname=e.fullname,this.field=e.field,this.text=e.text}var t="",n=[];return{setCurrentText:function(e){t="",e&&(t=e)},getCurrentTextReadable:function(){return t},getCurrentTextMachine:function(){var e=t,n=e.split(" ");return n.join("+")},getParams:function(){return n},addParam:function(t){var r=!1;angular.forEach(n,function(e){r||e.field!==t.field||e.text!==t.text||(r=!0)}),r||n.push(new e(t))},removeParam:function(e){var t=n.indexOf(e);n.splice(t,1)},removeAllParams:function(){n.length=0},getTextFromParams:function(){for(var e="",t=n.length,r=0;t>r;r++)r>0&&(e+=" "+n[r].operator+" "),e+=n[r].text+"["+n[r].field+"]";return e},setCurrentTextFromParams:function(){t=this.getTextFromParams()}}}),angular.module("genomeApp").factory("RequestHandler",["NcbiApi",function(e){function t(e){return e?e.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&").replace(/(\r\n|\n|\r)/gm,""):""}var n={summary:{general:function(t,n){var r={db:t,id:n.join()};return e.summary(r)},medgen:function(n,r){var a={db:n,id:r.join(),transformResponse:function(e){return angular.forEach(e.result,function(e){var n="<result>"+t(e.conceptmeta)+"</result>",r=new X2JS({arrayAccessForm:"property"});e.meta=r.xml_str2json(n)}),e}};return e.summary(a)}},fetch:{protein:function(t,n){var r={db:t,id:n,retmode:"xml",rettype:"fasta",transformResponse:function(e){var t=new X2JS;return t.xml_str2json(e)}};return e.fetch(r)}}};return{summary:function(e,t){var r=n.summary[e];return r?r(e,t):n.summary.general(e,t)},fetch:function(e,t){var r=n.fetch[e];return r?r(e,t):null}}}]),angular.module("genomeApp").directive("geSearchSlider",["$location",function(){return{replace:!0,restrict:"E",scope:{},controller:["$scope",function(){var e=!0,t=500,n=40,r=5,a=null,o=null;this.setLeftSide=function(e){a=e},this.setRightSide=function(e){o=e},this.toggleOpen=function(){e?(a.animate({left:"-"+(n-r)+"%"},t),o.animate({left:r+"%"},t)):(a.animate({left:"0px"},t),o.animate({left:n+"%"},t)),e=!e}}]}}]).directive("geLeftSide",function(){return{require:"^geSearchSlider",restrict:"E",replace:!0,transclude:!0,template:'<div id="search-section"><button class="toggle-btn grey-btn" ng-click="toggle()" style="float:right;"><fa class="fa fa-align-justify"></fa></button><div ng-transclude></div></div>',link:function(e,t,n,r){r.setLeftSide(t),e.toggle=function(){r.toggleOpen()}}}}).directive("geRightSide",function(){return{require:"^geSearchSlider",restrict:"E",replace:!0,transclude:!0,template:'<div id="search-results" ng-transclude></div>',link:function(e,t,n,r){r.setRightSide(t)}}}),angular.module("genomeApp").directive("geAdvancedSearch",["SearchQuery","NcbiApi","$timeout",function(e,t,n){return{templateUrl:"/search/directives/advanced-search/advanced-search.partial.html",replace:!0,restrict:"E",scope:{isOpen:"=",selectedDb:"="},link:function(r,a){function o(){a.animate({height:"0"},c),n(function(){a.css({display:"none"}),r.isOpen=!1},c)}function i(){a.css({display:"block"}),a.animate({height:"80%"},c),r.isOpen=!0}r.advancedFilters=[],r.selected={advancedFilter:null},r.newAdvancedFilter={text:""},r.advancedFilterOperators=[{name:"AND"},{name:"OR"},{name:"NOT"}],r.selectedAdvancedFilterOperator=r.advancedFilterOperators[0],r.queryParams=e.getParams(),r.clearAll=function(){r.selected.advancedFilter=null,r.newAdvancedFilter.text="",r.selectedAdvancedFilterOperator=r.advancedFilterOperators[0],e.removeAllParams()},r.addAdvancedFilter=function(t,n,a){e.addParam({operator:t.name,fullname:n.fullname,field:n.name,text:a}),r.newAdvancedFilter.text=""},r.removeParam=function(t){e.removeParam(t)},r.selectFilter=function(e){r.selected.advancedFilter=e},r.isFirst=function(){return 0===r.queryParams.length},r.search=function(){e.setCurrentTextFromParams(),r.isOpen=!1},r.close=function(){r.isOpen=!1};var c=200;r.$watch("isOpen",function(e){e?i():o()}),r.$watch(function(){return e.getTextFromParams()},function(e){r.queryStr=e}),r.$watch("selectedDb.name",function(e){e&&(r.advancedFilters.length=0,t.info({db:e}).then(function(e){r.advancedFilters=e.einforesult.dbinfo.fieldlist},function(e){console.log(e)}))})}}}]),angular.module("genomeApp").directive("geDbHelp",["SearchQuery","NcbiApi","$timeout",function(e,t,n){return{templateUrl:"/search/directives/db-help/db-help.partial.html",replace:!0,restrict:"E",scope:{isOpen:"=",selectedDb:"="},link:function(e,t){function r(){t.animate({height:"0"},o),n(function(){t.css({display:"none"}),e.isOpen=!1},o)}function a(){t.css({display:"block"}),t.animate({height:"80%"},o),e.isOpen=!0}e.close=function(){e.isOpen=!1};var o=200;e.$watch("isOpen",function(e){e?a():r()})}}}]);